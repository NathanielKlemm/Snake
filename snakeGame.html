<html>
<head>
<title>Snake Game</title>
<style>
body { text-align: center; font-family: Calibri, Arial, sans-serif; }
canvas { background:#2040C0; }
h2 { margin:0px; }
</style>
</head>
<body>
<h2>Level <span id="levelNum"></span></h2>
<canvas id="canvas" width="512px" height="512px"></canvas>
<script>
var canvas = document.getElementById("canvas"),
	context = canvas.getContext("2d"),
	levelNum = document.getElementById("levelNum"),
	gridSize = 32, //number of rows/columns in the (square) grid;
//note that the grid's origin is the center of the canvas, so the edges are all half a column/row
	cellSize = canvas.width/gridSize, //height/width in pixels of a (square) cell
	cells = [], //(gridSize+1)x(gridSize+1) array of cells;
//cells[0][0] is x=-16,y=-16; cells[16][16] is x=0,y=0; cells[32][32] is x=16,y=16
	victory = false,
	dead = false,
	level = 1;
	
function Vector(xValue,yValue) {
	this.x = xValue;
	this.y = yValue;
}

function Cell(isWall,isSnake) {
	this.isWall = isWall;
	this.isSnake = isSnake;
}

//Make the grid.
for (var col = 0; col <= gridSize; col++) {
	cells[col] = [];
	for (var row = 0; row <= gridSize; row++) {
		cells[col][row] = new Cell(false,false);
	}
}

//Food on the Game grid for the Player to eat.
function Food(count,location) {
	this.count = count; //Both one more than the number of Food the Player has eaten and the number of pieces of Food in this Food.
	//(e.g., if this is the fourth Food the Player for the Player to eat, there are four pieces of Food in this Food.)
	this.location = location; //The grid x and y coordinates of the piece of food.
	//Make the next Food for the Player to eat.
	this.increment = function() {
		this.count++;
		do {
			this.location.x = Math.round(Math.random()*(gridSize - 2) - (gridSize - 2)/2);
			this.location.y = Math.round(Math.random()*(gridSize - 2) - (gridSize - 2)/2);
		} while (cells[loc.x+gridSize/2][loc.y+gridSize/2].isWall);
	}
	//Draw the Food.
	this.draw = function() {
		context.fillStyle = "#ffff00";
		context.save();
		context.transform(1,0,0,-1,0,0);
		context.font = "10px Arial";
		context.fillText(this.count,(this.location.x-.25)*cellSize,-(this.location.y-0.25)*cellSize);
		context.restore();
	}
}

function Player(body,direction,length,color,full) {
	this.direction = direction; //The direction the Player is facing and thus moving.
	this.length = length; //The number of body segments, including the head.
	this.color = color; //A hex RGB color (e.g., "#ffff00")
	this.body = body; //Player.body is an array of each of the Player's body segments; each segment is one Cell. The Player's head is Player.body[0]. The Player's tail is Player.body[Player.length - 1].
	this.full = full; //How much Food the Player has in its belly. The Player grows one body segment for every piece of Food in the Player's belly.
	//Draws the Player.
	this.draw = function () {
		context.fillStyle = this.color;
		for (b = 0; b < this.length; b++) {
			context.beginPath();
			context.moveTo((this.body[b].x - 0.5)*cellSize, (this.body[b].y + 0.5)*cellSize); //upper left corner
			context.lineTo((this.body[b].x - 0.5)*cellSize, (this.body[b].y - 0.5)*cellSize); //lower left corner
			context.lineTo((this.body[b].x + 0.5)*cellSize, (this.body[b].y - 0.5)*cellSize); //lower right corner
			context.lineTo((this.body[b].x + 0.5)*cellSize, (this.body[b].y + 0.5)*cellSize); //upper right corner
			context.fill();
		}
	}
	//Turns the Player if an arrow key is pressed perpendicular to the direction the Player is facing.
	this.turn = function(dir) {
		if (dir == 37) { //left
			if (this.direction.x != 1) {
				this.direction.x = -1;
				this.direction.y = 0;
			}
		}
		else if (dir == 38) { //up
			if (this.direction.y != -1) {
			this.direction.x = 0;
			this.direction.y = 1;
			}
		}
		else if (dir == 39) { //right
			if (this.direction.x != -1) {
			this.direction.x = 1;
			this.direction.y = 0;
			}
		}
		else if (dir == 40) { //down
			if (this.direction.y != 1) {
			this.direction.x = 0;
			this.direction.y = -1;
			}
		}
		draw();
	}
	//Either move or grow, depending on if the Player has Food in its belly.
	this.act = function() {
		if (this.full > 0) { //if the Player has Food in its belly
			this.grow();
		}
		else {
			this.move();
		}
	}
	//Moves the whole snake - both the head and the tail.
	this.move = function() {
		//The Cell with the end of the snake becomes not a part of the body anymore.
		var x = this.body[this.length - 1].x,
			y = this.body[this.length - 1].y;
		cells[x+gridSize/2][y+gridSize/2].isSnake = false;
		//Move every body segment (except the head) one body segment forward.
		for (var b = 0; b < this.length - 1; b++) {
			this.body[this.length - b - 1].x = this.body[this.length - b - 2].x;
			this.body[this.length - b - 1].y = this.body[this.length - b - 2].y;
		}
		//Move the head one Cell in the direction the Player is facing.
		this.body[0].x += this.direction.x;
		this.body[0].y += this.direction.y;
		//The Cell that used to be the head now is part of the body.
		if (this.length > 1) {
			x = this.body[1].x;
			y = this.body[1].y;
			cells[x+gridSize/2][y+gridSize/2].isSnake = true;
		}
	}
	//Eat Food.
	this.eat = function(count) {
		this.full += count; //The number of the Food (count) is the number of body lengths the Player will grow.
	}
	//If the player has food in its belly, its tail will stay put while its head moves.
	this.grow = function() {
		//Increase the length by one
		this.length++;
		//Make a new body segment where the end of the body used to be
		var x = this.body[this.length - 2].x,
			y = this.body[this.length - 2].y;
		this.body[this.length - 1] = new Vector(x,y);
		//Move each body segment forward one except the new segment at the end.
		for (var b = 1; b < this.length - 1; b++) {
			this.body[this.length - b - 1].x = this.body[this.length - b - 2].x;
			this.body[this.length - b - 1].y = this.body[this.length - b - 2].y;
		}
		//Move the head one Cell in the direction the Player is facing.
		this.body[0].x += this.direction.x;
		this.body[0].y += this.direction.y;
		//The Cell that used to be the head now is part of the body.
		x = this.body[1].x;
		y = this.body[1].y;
		cells[x+gridSize/2][y+gridSize/2].isSnake = true;
		//Decrease the amount of food in the Player's belly by one.
		this.full--;
	}
}

//Draw all walls.
function drawWalls() {
	context.fillStyle = "#000000";
	//Loop over all cells in the grid.
	for (col = -gridSize/2; col <= gridSize/2; col++) {
		for (row = -gridSize/2; row <= gridSize/2; row++) {
			if (cells[col+gridSize/2][row+gridSize/2].isWall) {
				context.beginPath();
				context.moveTo((col - 0.5)*cellSize, (row + 0.5)*cellSize); //upper left corner of the cell
				context.lineTo((col - 0.5)*cellSize, (row - 0.5)*cellSize); //lower left corner of the cell
				context.lineTo((col + 0.5)*cellSize, (row - 0.5)*cellSize); //lower right corner of the cell
				context.lineTo((col + 0.5)*cellSize, (row + 0.5)*cellSize); //upper right corner of the cell
				context.fill();
			}
		}
	}
}

function keyDown(event) {
	var key = event.keyCode;
	if (!dead) {
		if (!victory && key <= 40 && key >= 37) { //Arrow keys
			player1.turn(key);
		}
		else if (key == 89 && victory) { //"Y" for next level
			level++;
			victory = false;
			start();
		}
	}
}

document.addEventListener("keydown",keyDown,false);

function draw() {
	context.clearRect(-canvas.width/2,canvas.height/2,canvas.width,-canvas.height); //erase the canvas
	drawWalls(); //draw the walls
	nibble.draw(); //draw the food
	player1.draw(); //draw the player
}

function play() {
	player1.act();
	
	if (player1.body[0].x == nibble.location.x && player1.body[0].y == nibble.location.y) {
		nibble.increment();
		player1.eat(nibble.count);
		if (nibble.count > 10) {
			victory = true;
		}
	}
	
	//If the Player hasn't won yet and the Player hasn't hit a wall or itself, redraw the Game and continue.
	if (!victory && !cells[player1.body[0].x + gridSize/2][player1.body[0].y + gridSize/2].isWall && !cells[player1.body[0].x + gridSize/2][player1.body[0].y + gridSize/2].isSnake) {
		draw();
		window.setTimeout(play,1000/8);
	}
	//If the Player won
	else if (victory) {
		context.save();
		context.transform(1,0,0,-1,0,0);
		context.fillStyle = "#ffffff";
		context.font = "30px Arial";
		context.fillText("You win! Next level? (Y = Yes)",-3*canvas.width/8,-10);
		context.restore();
	}
	//If the Player hit a wall 
	else {
		dead = true;
		context.transform(1,0,0,-1,0,0);
		context.fillStyle = "#ffffff";
		context.font = "30px Arial";
		context.fillText("Game Over",-canvas.width/6,-10);
	}
}

function start() {
	levelNum.innerHTML = level; //Show the level number in the header.
	
	//Make the grid.
	for (var col = 0; col <= gridSize; col++) {
		for (var row = 0; row <= gridSize; row++) {
			cells[col][row].isWall = false;
			cells[col][row].isSnake = false;
		}
	}

	//Make the walls for Level 1.
	for (var row = 0; row <= gridSize; row++) {
		cells[0][row].isWall = true;
		cells[gridSize][row].isWall = true;
	}

	for (var col = 0; col <= gridSize; col++) {
		cells[col][0].isWall = true;
		cells[col][gridSize].isWall = true;
	}
	
	//Make Player1.
	position = new Vector(0,0);
	velocity = new Vector(-1,0);
	player1 = new Player([position],velocity,1,"#ffff00",false);
	
	//Make the Level.
	if (level == 2) {
		for (var col = 0; col <= gridSize/2; col++) {
			cells[col + gridSize/4][gridSize/2].isWall = true;
		}
		position.x = 0;
		position.y = gridSize/4;
		velocity.x = -1;
		velocity.y = 0;
		player1.body = [position];
		player1.direction = velocity;
		player1.color = "#ffff00";
		player1.full = false;
	}
	else if (level == 3) {
		for (var col = 0; col <= gridSize/2; col++) {
			cells[col + gridSize/4][gridSize/2].isWall = true;
		}
		for (var row = 0; row <= gridSize/2; row++) {
			cells[gridSize/2][row + gridSize/4].isWall = true;
		}
		position.x = gridSize/4;
		position.y = 3*gridSize/8;
		velocity.x = -1;
		velocity.y = 0;
		player1.body = [position];
		player1.direction = velocity;
		player1.color = "#ffff00";
		player1.full = false;
	}
	else if (level == 4) {
		for (var col = 0; col <= 3*gridSize/8; col++) {
			cells[col][3*gridSize/8].isWall = true;
		}
		for (var col = 0; col <= 3*gridSize/8; col++) {
			cells[col + 5*gridSize/8][5*gridSize/8].isWall = true;
		}
		for (var row = 0; row <= 3*gridSize/8; row++) {
			cells[3*gridSize/8][row + 5*gridSize/8].isWall = true;
		}
		for (var row = 0; row <= 3*gridSize/8; row++) {
			cells[5*gridSize/8][row].isWall = true;
		}
		position.x = -5*gridSize/16;
		position.y = gridSize/4;
		velocity.x = 0;
		velocity.y = -1;
		player1.body = [position];
		player1.direction = velocity;
		player1.color = "#ffff00";
		player1.full = false;
	}
	else if (level == 5) {
		for (var col = 0; col <= 3*gridSize/4; col++) {
			cells[col+gridSize/8][col+gridSize/8].isWall = true;
		}
		for (var col = 0; col <= 3*gridSize/4; col++) {
			cells[col + gridSize/8][7*gridSize/8-col].isWall = true;
		}
		cells[gridSize/2][gridSize/2].isWall = false;
		position.x = 0;
		position.y = 7*gridSize/16;
		velocity.x = 1;
		velocity.y = 0;
		player1.body = [position];
		player1.direction = velocity;
		player1.color = "#ffff00";
		player1.full = false;
	}
	
	//Put the Food in a location without Walls.
	do {
	loc = new Vector(Math.round(Math.random()*(gridSize - 2) - (gridSize - 2)/2),Math.round(Math.random()*(gridSize - 2) - (gridSize - 2)/2));
	} while (cells[loc.x+gridSize/2][loc.y+gridSize/2].isWall);
	nibble = new Food(1,loc);

	draw(); //Draw everything.
	play(); //Start moving.
}

context.transform(1,0,0,-1,canvas.width/2,canvas.height/2);
start();

</script>
</body>
</html>